{%- import "cloudevents.jinja.include" as cloudEvents -%}
{%- import "servicebus.jinja.include" as servicebus -%}
{%- set messagegroups = root.messagegroups %}
{%- set uses_cloudevents_message = (root | exists( "format", "cloudevents" )) %}
{%- set uses_amqp_message = (root | exists( "format", "amqp" )) %}
{%- set uses_amqp_endpoint = (root | exists( "protocol", "amqp" )) %}
{%- set function_name = project_name | pascal -%}
using System;
using System.Threading.Tasks;
using Azure;
using Azure.Core;
using Azure.Messaging.ServiceBus;
using Microsoft.Extensions.Logging;
{%- if uses_cloudevents_message %}
using CloudNative.CloudEvents;
using CloudNative.CloudEvents.Core;
using CloudNative.CloudEvents.SystemTextJson;
using CloudNative.CloudEvents.Avro;
using CloudNative.CloudEvents.Protobuf;
{%- endif %}
 
{% for messagegroup_key, messagegroup in messagegroups.items() -%}
 {%- set pascalGroupName = messagegroup.id | default(messagegroup_key) | pascal -%}
namespace {{ project_name | pascal }}
{
     {%- set class_name = ( pascalGroupName | strip_namespace )+"EventConsumer" %}
    public class {{ class_name }} : IDisposable
    {
        private const string amqpCloudEventPrefix1 = "cloudEvents_";
        private const string amqpCloudEventPrefix2 = "cloudEvents:";
        private ServiceBusProcessor serviceBusProcessor;
        private readonly ILogger logger;
        private static readonly CloudEventFormatter jsonFormatter = new JsonEventFormatter();
        private static readonly CloudEventFormatter protoFormatter = new ProtobufEventFormatter();
        private static readonly CloudEventFormatter avroFormatter = new global::CloudNative.CloudEvents.Avro.AvroEventFormatter();
        {{ cloudEvents.DeclareDispatchObjectsFields( messagegroups ) | indent(8) }}
        {{ cloudEvents.DeclareDispatchObjectsConstructor( project_name, class_name, messagegroups, 
          "ServiceBusProcessor serviceBusProcessor, ILoggerFactory? loggerFactory", 
          "loggerFactory = loggerFactory ?? Microsoft.Extensions.Logging.Abstractions.NullLoggerFactory.Instance;\n" +
          "this.logger = loggerFactory.CreateLogger<"+class_name+">();\n" +
          "this.serviceBusProcessor = serviceBusProcessor;") | indent(8) }}
        {{ cloudEvents.DeclareDispatchObjectsConstructor( project_name, class_name, messagegroups, 
          "ServiceBusProcessor serviceBusProcessor", 
          "var loggerFactory = Microsoft.Extensions.Logging.Abstractions.NullLoggerFactory.Instance;\n" +
          "this.logger = loggerFactory.CreateLogger<"+class_name+">();\n" +
          "this.serviceBusProcessor = serviceBusProcessor;") | indent(8) }}
        private string? GetCloudEventAttribute(ServiceBusReceivedMessage serviceBusMessage, string key)
        {
            if (serviceBusMessage.ApplicationProperties.TryGetValue(amqpCloudEventPrefix1+key, out var value) ||
                serviceBusMessage.ApplicationProperties.TryGetValue(amqpCloudEventPrefix2+key, out value))
            {
                return value as string;
            }
            return null;
        } 

        private CloudEvent CloudEventFromServiceBusMessage(ServiceBusReceivedMessage serviceBusMessage) 
        {
            CloudEventFormatter? formatter = null;
            var contentType = serviceBusMessage.ContentType?.Split(';')[0];
            if ( contentType != null && contentType.StartsWith("application/cloudevents") )
            {
                formatter = contentType.EndsWith("+proto") ? protoFormatter: contentType.EndsWith("+avro") ? avroFormatter : jsonFormatter;
                return formatter.DecodeStructuredModeMessage(serviceBusMessage.Body.ToStream(), new System.Net.Mime.ContentType(contentType), null);
            }
            else
            {
                // binary mode
                var cloudEvent = new CloudEvent()
                {
                    Data = serviceBusMessage.Body,
                    DataContentType = contentType,
                };
                string? specVersion = GetCloudEventAttribute(serviceBusMessage, "specversion");
                if (specVersion != "1.0") throw new Exception("Unsupported CloudEvent specversion: " + specVersion);
                string? dataSchema = GetCloudEventAttribute(serviceBusMessage, "dataschema");
                string? time = GetCloudEventAttribute(serviceBusMessage, "time");
                string? source = GetCloudEventAttribute(serviceBusMessage, "source");
                string? subject = GetCloudEventAttribute(serviceBusMessage, "subject");
                string? type = GetCloudEventAttribute(serviceBusMessage, "type");
                string? id = GetCloudEventAttribute(serviceBusMessage, "id");
                if (dataSchema != null) cloudEvent.DataSchema = new Uri(dataSchema);
                if (time != null) cloudEvent.Time = DateTime.Parse(time);
                if (source != null) cloudEvent.Source = new Uri(source);
                if (subject != null) cloudEvent.Subject = subject;
                if (type != null) cloudEvent.Type = type;
                if (id != null) cloudEvent.Id = id;
                foreach (var key in serviceBusMessage.ApplicationProperties.Keys)
                {
                    if (key.StartsWith(amqpCloudEventPrefix1) || key.StartsWith(amqpCloudEventPrefix2))
                    {
                        var attributeName = key.Substring(amqpCloudEventPrefix1.Length);
                        cloudEvent[attributeName] = serviceBusMessage.ApplicationProperties[key] as string;
                    }
                }
                return cloudEvent;
            }
            
        }

        public static bool IsCloudEvent(ServiceBusReceivedMessage serviceBusMessage) =>
            MimeUtilities.IsCloudEventsContentType(serviceBusMessage.ContentType) ||
            serviceBusMessage.ApplicationProperties.ContainsKey(amqpCloudEventPrefix1) ||
            serviceBusMessage.ApplicationProperties.ContainsKey(amqpCloudEventPrefix2);

        private async Task ProcessMessageAsync(ProcessMessageEventArgs messageArgs)
        {
            try 
            {
                {%- if uses_cloudevents_message %}
                if ( IsCloudEvent(messageArgs.Message) )
                {
                    var cloudEvent = CloudEventFromServiceBusMessage(messageArgs.Message);
                    await DispatchCloudEventAsync(cloudEvent);
                }
                {%- endif %}
                {%- if uses_amqp_message %}
                var serviceBusMessage = messageArgs.Message;
                if (serviceBusMessage != null)
                {
                    await DispatchMessageAsync(serviceBusMessage);
                }
                {%- endif %}
            }
            catch (Exception ex)
            {
                this.logger.LogError(ex, "Error processing event");
                throw;
            }
        }

        private Task ProcessErrorAsync(ProcessErrorEventArgs messageArgs)
        {
            this.logger.LogError(messageArgs.Exception, "Error processing event");
            return Task.CompletedTask;
        }
        
        {%- if uses_cloudevents_message %}        
        public async Task DispatchCloudEventAsync(CloudEvent cloudEvent)
        {
            try 
            {
                {{ cloudEvents.DispatchToDispatchObjects( "cloudEvent", messagegroups, "this.logger" ) | indent(16) }}
            }
            catch (Exception ex)
            {
                this.logger.LogError(ex, "Error dispatching message");
            }
        }
        {%- endif %}

        {%- if uses_amqp_message %}
        public async Task DispatchMessageAsync(ServiceBusReceivedMessage serviceBusMessage)
        {
            try 
            {
                {{ servicebus.DispatchToDispatchObjects( "serviceBusMessage", messagegroups, "this.logger" ) | indent(16) }}
            }
            catch (Exception ex)
            {
                this.logger.LogError(ex, "Error dispatching message");
            }
        }
        {%- endif %}

        public async Task StartProcessingAsync(CancellationToken cancellationToken = default)
        {
            serviceBusProcessor.ProcessMessageAsync += ProcessMessageAsync;
            serviceBusProcessor.ProcessErrorAsync += ProcessErrorAsync;
            await serviceBusProcessor.StartProcessingAsync(cancellationToken);
        }

        public async Task StopProcessingAsync(CancellationToken cancellationToken = default)
        {
            try
            {
                await serviceBusProcessor.StopProcessingAsync(cancellationToken);
            }
            finally
            {
                // To prevent leaks, the handlers should be removed when processing is complete.

                serviceBusProcessor.ProcessMessageAsync -= ProcessMessageAsync;
                serviceBusProcessor.ProcessErrorAsync -= ProcessErrorAsync;
            }
        }

        public void Dispose()
        {
            this.StopProcessingAsync().GetAwaiter().GetResult();
        }

        {%- if root.endpoints -%} 
        {%- for endpoint_key in root.endpoints.keys() -%}
        {%- set endpoint = root.endpoints[endpoint_key] -%}
        {%- if endpoint.usage == "producer" -%}
        {%- set protocol = endpoint.config.protocol | lower -%}
        {%- if protocol == "amqp" -%}
        {%- set options = endpoint.config.options -%}
        {%- set endpoints = endpoint.config.endpoints %}
        {%- macro createforbody(class_name, endpoints, options) -%}
            if ( fullyQualifiedNamespace == null )
            {
                {%- if endpoints %}
                fullyQualifiedNamespace = "{{ endpoints[0] }}";
                {%- else %}
                throw new ArgumentNullException(nameof(fullyQualifiedNamespace));
                {%- endif %}
            }
            if ( eventHubName == null )
            {
                {%- if options and 'node' in options %}
                eventHubName = "{{ options['node'] }}";
                {%- else %}
                throw new ArgumentNullException(nameof(eventHubName));
                {%- endif %}
            }
            if ( consumerGroupName == null )
            {
                {%- if options and 'consumer_group' in options %}
                consumerGroupName = "{{ options['consumer_group'] }}";
                {%- else %}
                consumerGroupName = "$Default";
                {%- endif %}
            }
            var serviceBusProcessor = new ServiceBusProcessor(checkpointBlobClient, consumerGroupName, fullyQualifiedNamespace, eventHubName, credential);
            return new {{ class_name }}(serviceBusProcessor);
        {%- endmacro %}
        
        public static {{ class_name }} CreateFor{{ endpoint_key | pascal | strip_namespace }}(BlobContainer checkpointBlobClient, Client TokenCredential credential, string? fullyQualifiedNamespace = null, string? eventHubName = null, string? consumerGroupName = null) 
        {   
            {{ createforbody(class_name, endpoints, options) }}
        }

        public static {{ class_name }} CreateFor{{ endpoint_key | pascal | strip_namespace }}(BlobContainer checkpointBlobClient, AzureNamedKeyCredential credential, string? fullyQualifiedNamespace = null, string? eventHubName = null, string? consumerGroupName = null) 
        {       
            {{ createforbody(class_name, endpoints, options) }}
        }

        public static {{ class_name }} CreateFor{{ endpoint_key | pascal | strip_namespace }}(BlobContainer checkpointBlobClient, AzureSasCredential credential, string? fullyQualifiedNamespace = null, string? eventHubName = null, string? consumerGroupName = null) 
        {       
            {{ createforbody(class_name, endpoints, options) }}
        }
        {%- endif -%}
        {%- endif -%}
        {%- endfor -%}
        {% endif %}
    }

}
{% endfor %}