{%- import "cloudevents.jinja.include" as cloudEvents -%}
{%- import "mqtt.jinja.include" as mqtt -%}
{%- set messagegroups = root.messagegroups %}
{%- set uses_cloudevents_message = (root | exists( "format", "cloudevents" )) %}
{%- set uses_mqtt_message = (root | exists( "binding", "mqtt" )) %}
{%- set uses_mqtt_endpoint = (root | exists( "protocol", "mqtt" )) %}

using CloudNative.CloudEvents;
using CloudNative.CloudEvents.SystemTextJson;
{%- if uses_mqtt_message %}
{{ mqtt.MqttNetHeaders() }}
{%- endif %}
using Microsoft.Extensions.Logging;
 
{% for messagegroup_key, messagegroup in messagegroups.items() -%}
{%- set pascalGroupName = messagegroup.id  | pascal -%}
namespace {{ project_name | pascal }}
{
    {%- set class_name = ( pascalGroupName | strip_namespace )+"EventProducer" %}
    public partial class {{ class_name }}
    {
        
        {%- if uses_cloudevents_message %}
        private readonly ContentMode contentMode;
        private readonly CloudEventFormatter formatter;
        public event EventHandler<CloudEvent>? BeforeSend;
        {%- endif %}
        private readonly MqttProducer endpoint;
        public {{ class_name }}(MqttProducer endpoint{%- if uses_cloudevents_message -%}, ContentMode contentMode, CloudEventFormatter formatter{%- endif -%})
        {
            {%- if uses_cloudevents_message %}
            this.contentMode = contentMode;
            this.formatter = formatter;
            {%- endif %}
            this.endpoint = endpoint;
        }

        {%- if root.endpoints -%} 
        {%- for endpoint_key in root.endpoints.keys() -%}
        {%- set endpoint = root.endpoints[endpoint_key] -%}
        {%- if endpoint.usage == "producer" -%}
            {%- set protocol = endpoint.config.protocol | lower -%}
            {%- set options = endpoint.config.options -%}
            {%- set endpoints = endpoint.config.endpoints %}
                
        public static {{ class_name }} CreateFor{{ endpoint_key | pascal | strip_namespace }}(ILogger logger, EndpointCredential credential {% if uses_cloudevents_message %}, ContentMode contentMode, CloudEventFormatter formatter {% endif %}) 
        {       
            {%- if options %}
            var options = new Dictionary<string, string> {
            {%- for key, value in options.items()%}
                { "{{ key }}" , "{{ value }}" }
                {%- if not loop.last -%},{%- endif %}
            {%- endfor %}
            };
            {%- endif %}
            var endpoints = new List<Uri> {
            {%- for epo in endpoints %}
                new Uri("{{ epo.uri }}")
                {%- if not loop.last -%},{%- endif %}
            {%- endfor %}
            };
            return new {{ class_name }}(new MqttProducer(logger, credential,  {% if options %}options, {% else %}new Dictionary<string,string>(), {% endif %}endpoints){%- if uses_cloudevents_message %}, contentMode, formatter{%- endif %});
        }
        {%- endif -%}
        {%- endfor -%}
        {% endif %}

        {% for id in messagegroup.messages -%}
        {%- set definition = messagegroup.messages[id] -%}
        {%- set pascalDefinitionName = definition.id | pascal %}
        {%- set isCloudEvent = not definition.format or definition.format.lower().startswith("cloudevents") -%}
        {%- set isMqtt = not isCloudEvent and definition.format.lower().startswith("mqtt") %}
        public async Task Send{{ pascalDefinitionName | strip_namespace }}Async(
        {%- if definition.schemaurl or definition.schema -%}
        global::{{ (definition.schemaurl if definition.schemaurl else definition.schema) | schema_type( project_name, root, definition.schemaformat) | pascal }} data
        {%- else -%}
        object data
        {%- endif %}    
        {%- if isCloudEvent -%}
        {{- cloudEvents.DeclareUriTemplateArguments(definition) -}}
        {%- elif isMqtt -%}
        {{- mqtt.DeclareUriTemplateArguments(definition) -}}
        {%- endif -%}
        )
        {
            {% if isCloudEvent %}
            string? contentType = null;
            {{- cloudEvents.DeclareCloudNativeCloudEvent("cloudEvent", definition) | indent(12)}}
            cloudEvent.Data = {% if definition.schemaurl -%}
            {%- set schemaObj = schema_object(root, definition.schemaurl ) -%}
            {%- if schemaObj and "format" in schemaObj and not schemaObj.format.lower().startswith("json") -%}
            data.ToByteArray(out contentType)
            {%- else -%}
            data
            {%- endif -%}
            {%- else -%}data{%- endif %};
            cloudEvent.DataContentType = contentType;
            BeforeSend?.Invoke(this, cloudEvent);
            await endpoint.SendAsync(cloudEvent, contentMode, formatter);
            {% elif isMqtt %}
            {{- mqtt.DeclareMqttNetMessage("mqttMessage", definition) | indent(12)}}
            mqttMessage.Payload = {% if definition.schemaurl -%}data.Clone(){%- else -%}data{%- endif %}.ToByteArray();
            await ((MqttMqttProducer)endpoint).SendAsync(mqttMessage);
            {%- endif %}
        }
        {% endfor %}
    }
}
{% endfor -%}