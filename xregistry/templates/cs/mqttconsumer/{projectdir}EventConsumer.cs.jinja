{%- import "cloudevents.jinja.include" as cloudEvents -%}
{%- import "mqtt.jinja.include" as mqtt -%}
{%- set messagegroups = root.messagegroups %}
{%- set uses_cloudevents_message = (root | exists( "format", "cloudevents" )) %}
{%- set uses_mqtt_message = (root | exists( "binding", "mqtt" )) %}
{%- set uses_mqtt_endpoint = (root | exists( "protocol", "mqtt" )) %}
{%- set function_name = project_name | pascal -%}
using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using System.Linq;
using System.Text.RegularExpressions;

{%- if uses_cloudevents_message %}
using CloudNative.CloudEvents;
using CloudNative.CloudEvents.SystemTextJson;
{%- endif %}
{%- if uses_mqtt_message %}
{{ mqtt.MqttNetHeaders() }}
{%- endif %}
using Microsoft.Extensions.Logging;
 
{% for messagegroup_key, messagegroup in messagegroups.items() -%}
 {%- set pascalGroupName = messagegroup.id  | pascal -%}
namespace {{ project_name | pascal }}
{
     {%- set class_name = ( pascalGroupName | strip_namespace )+"EventConsumer" %}
    public class {{ class_name }} : IDisposable
    {
        {%- if uses_cloudevents_message %}
        {{ cloudEvents.DeclareDispatchObjectsFields( project_name, messagegroups ) | indent(8) }}
        {{ cloudEvents.DeclareDispatchObjectsConstructor( project_name, class_name, messagegroups, "MqttConsumer endpoint", "this.endpoint = endpoint;\nthis.endpoint.DispatchCloudEventAsync += DispatchCloudEventAsync;") | indent(8) }}
        {%- endif %}
        {%- if uses_mqtt_message %}
        {{ mqtt.DeclareDispatchObjectsFields( project_name, messagegroups ) | indent(8) }}
        {{ mqtt.DeclareDispatchObjectsConstructor( project_name, class_name, messagegroups, "MqttConsumer endpoint", "this.endpoint = endpoint;\nthis.endpoint.DispatchApplicationMessageAsync += DispatchApplicationMessageAsync;") | indent(8) }}
        {%- endif %}

        private MqttConsumer endpoint;
        
        public Task StartAsync() => this.endpoint.StartAsync();
        public Task StopAsync() => this.endpoint.StopAsync();

        {%- if uses_cloudevents_message %}
        
        public async Task DispatchCloudEventAsync( CloudEvent cloudEvent, ILogger log)
        {
            try 
            {
                {{ cloudEvents.DispatchToDispatchObjects(project_name, root, "cloudEvent", messagegroups, "log" ) | indent(16) }}
            }
            catch (Exception ex)
            {
                log.LogError(ex, "Error dispatching message");
            }
        }
        {%- endif %}
        
        {%- if uses_mqtt_message %}
        public async Task DispatchApplicationMessageAsync( MqttApplicationMessage mqttMessage, ILogger log)
        {
            try 
            {
               {{ mqtt.DispatchToDispatchObjects(project_name, root, "mqttMessage", messagegroups, "log" ) | indent(16) }}
            }
            catch (Exception ex)
            {
                log.LogError(ex, "Error dispatching message");
            }
        }
        {%- endif %}

        public void Dispose()
        {
            this.endpoint.Dispose();
        }

        {%- if root.endpoints -%} 
         {%- for endpoint_key in root.endpoints.keys() -%}
         {%- set endpoint = root.endpoints[endpoint_key] -%}
         {%- if endpoint.usage == "consumer" -%}
           {%- set protocol = endpoint.config.protocol | lower -%}
           {%- set options = endpoint.config.options -%}
           {%- set endpoints = endpoint.config.endpoints %}
           {%- set isCloudEvent = not endpoint.format or endpoint.format.lower().startswith("cloudevents") -%}
           {%- set isMqtt = not isCloudEvent and endpoint.format.lower().startswith("mqtt") %}
                
        public static {{ class_name }} CreateFor{{ endpoint_key | pascal | strip_namespace }}(ILogger logger, EndpointCredential credential, {{ cloudEvents.DeclareDispatchObjectsArgs( project_name,  messagegroups, true ) }}{{ mqtt.DeclareDispatchObjectsArgs( project_name,  messagegroups, true ) }}) 
        {       
            {%- if options %}
            var options = new Dictionary<string, string> {
            {%- for key, value in options.items()%}
                { "{{ key }}" , "{{ value }}" }
                {%- if not loop.last -%},{%- endif %}
            {%- endfor %}
            };
            {%- endif %}
            var endpoints = new List<Uri> {
            {%- for epo in endpoints %}
                new Uri("{{ epo.uri }}")
                {%- if not loop.last -%},{%- endif %}
            {%- endfor %}
            };
            var endpoint = new MqttConsumer(logger, credential,  {% if options %}options, {% else %}null, {% endif %}endpoints);
            var consumer = new {{ class_name }}(endpoint, {{ cloudEvents.DeclareDispatchObjectsArgs( project_name,  messagegroups, false ) -}}{{ mqtt.DeclareDispatchObjectsArgs( project_name,  messagegroups, false ) -}});
            return consumer;
        }
        {%- endif -%}
        {%- endfor -%}
        {% endif %}
    }

}
{% endfor %}